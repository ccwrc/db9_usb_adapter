DB9-USB-adapter
===============

Adapter for connecting USB joystick/gamepad to DB9 joystick connector found in
Atari, Commodore and Amiga computers.

Joystick/gamepad usage
----------------------

Plug USB joystick or gamepad into adapter's USB socket, plug the adapter into
an Atari/Commodore/Amiga computer's joystick port and turn on the computer.
The yellow LED (D1) should turn on indicating successful joystick/gamepad 
recognition. At this point you can use the (USB) joystick/gamepad as you would
an original one.

If the joystick/gamepad is recognized but does not work out-of-the-box
as expected you can write a custom joystick descriptor (see next section).

Custom joystick descriptors
---------------------------

### Overview

Custom joystick descriptor is a set of 'instructions' telling the adapter
how to handle USB HID reports of a specific joystick/gamepad.

Data required to write a descriptor is transmitted through adapter's UART
connector (3.3 V TTL logic, 38400 baud). You can also use a software tool
and a computer with USB port to display USB HID reports generated by a
joystick/gamepad.

### Data dumped through UART - example session

I:reset
I:VID:PID 054C:0268
I:VID:PID 0E8F:0003
I:report:0000[80 80 80 80 00 0F 00 00] <-- idle state
I:report:0000[80 80 80 80 00 00 00 01] <-- forward pressed
I:report:0000[80 80 80 80 00 0F 00 00] <-- forward released
I:report:0000[80 80 80 80 00 04 00 04] <-- backward pressed
I:report:0000[80 80 80 80 00 0F 00 00] <-- backward released
I:report:0000[80 80 80 80 00 06 00 08] <-- left pressed
I:report:0000[80 80 80 80 00 0F 00 00] <-- left released
I:report:0000[80 80 80 80 00 02 00 02] <-- right pressed
I:report:0000[80 80 80 80 00 0F 00 00] <-- right released
I:report:0000[80 80 80 80 00 0F 01 00] <-- fire button 1 pressed
I:report:0000[80 80 80 80 00 0F 00 00] <-- fire button 1 released

### Loading joystick descriptors into adapter's flash memory

Convert text descriptor to a binary form and write it to a FAT32-formatted
pendrive. Target file must be named joy.dat. Example:

  $ python tools/joy_data_converter.py data/db9usb.conf > /mnt/pendrive/db9usb.dat

Plug the pendrive into adapter's USB connector and adapter into a computer's
joystick port. Turn on the computer. Wait until yellow LED (D1) and red LED
(D2) turn on - this indicates the pendrive is recognized and the descriptor is
loaded into adapter's flash memory.

### Descriptor syntax

Descriptor file contains one or more descriptors. Lines starting with a '#'
are ignored. BYTE is a 2-digit hexadecimal number, WORD - 4-digit hexadecimal
number. Each of the actions (left, right, forward, backward or fire) is triggered when
HID report data at `offset` masked with `mask` is equal/not equal to `value`.

descriptor ::= vid_pid report_id control+
vid_pid ::= 'vid:pid' vid ':' pid '\n'
'report_id' '=' BYTE '\n'
vid ::= WORD
pid ::= WORD
control ::= action '[' offset ']' '&' mask operator value '\n'
action ::= 'left' | 'right' | 'forward' | 'backward' | 'fire'
offset ::= BYTE
mask ::= BYTE
operator ::= '==' | '!='
value ::= BYTE

### Example descriptor

# GreenAsia Inc. USB Joystick aka. Sony Corp. Batoh Device / PlayStation 3 Controller
vid:pid 0e8f:0003
report_id 00
left     [7] & 0f = 08
right    [7] & 0f = 02
forward  [7] & 0f = 01
backward [7] & 0f = 04
fire     [5] & f0 != 00
fire     [6] & 0f != 00

Development
-----------

### MPLABX settings

Microcontroller: PIC32MX250F128D
Include paths:
 "inc"
 "<LIBRARIES-FOR-APPLICATIONS-2013-06-15>/Microchip/Include"
 "<LIBRARIES-FOR-APPLICATIONS-2013-06-15>/Microchip/Include/MDD File System"
 "<LIBRARIES-FOR-APPLICATIONS-2013-06-15>/Microchip/USB"
Heap size: 8192

### Files to be copied from libraries for applications 2013-06-15
USB/usb_host.c
USB/usb_host_hid.c
USB/usb_host_hid_parser.c
USB/usb_host_msd.c
USB/usb_host_msd_scsi.c
MDD File System/FSIO.c
